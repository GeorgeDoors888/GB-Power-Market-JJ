<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>GSP Flow Map - GB Grid Supply Points</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #1a1a1a; color: #fff; }
        #map { height: 100vh; width: 100%; }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #4CAF50;
            z-index: 1000;
        }
        .info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.95);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #4CAF50;
            max-width: 400px;
            z-index: 100;
        }
        h2 { margin: 0 0 15px 0; color: #4CAF50; }
        .stat {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
        }
        .exp {
            background: rgba(0,188,212,0.3);
            border-left: 4px solid #00bcd4;
        }
        .legend {
            position: absolute;
            bottom: 30px;
            right: 20px;
            background: rgba(0,0,0,0.95);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #4CAF50;
            z-index: 100;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        .circle {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #fff;
        }
    </style>
</head>
<body>
    <div id="loading">‚ö° Loading Map...</div>
    <div id="map"></div>
    
    <div class="info">
        <h2>‚ö° GB Grid Supply Points</h2>
        <p style="font-size:12px;color:#aaa;margin:5px 0">29 October 2025, SP48 (23:30)</p>
        <p style="font-size:13px">Total GSP Areas: <strong id="totalGsp">18</strong></p>
        <div class="stat exp">
            <strong>üü¶ Net Exporters: <span id="expCount">18</span> areas</strong><br>
            <small style="color:#aaa">Generation exceeds local demand</small>
        </div>
    </div>
    
    <div class="legend">
        <div style="font-weight:bold;margin-bottom:10px">Legend</div>
        <div class="legend-item">
            <div class="circle" style="background:rgba(0,188,212,0.7)"></div>
            <span>Net Exporter</span>
        </div>
        <div class="legend-item">
            <div class="circle" style="background:rgba(255,152,0,0.7)"></div>
            <span>Net Importer</span>
        </div>
        <div style="font-size:11px;color:#aaa;margin-top:10px">Circle size = flow magnitude</div>
    </div>

    <script>
        console.log('Script started...');
        
        const gspData = [
            {"gsp": "N", "name": "National Grid", "lat": 54.5, "lng": -3.5, "gen": 84108447, "dem": 50868693, "net": 33239754},
            {"gsp": "B9", "name": "Pelham", "lat": 51.7422, "lng": -0.0475, "gen": 62689029, "dem": 19471078, "net": 43217951},
            {"gsp": "B8", "name": "Sundon", "lat": 51.9476, "lng": -0.4682, "gen": 59916701, "dem": 15209984, "net": 44706717},
            {"gsp": "B16", "name": "Pembroke", "lat": 51.675, "lng": -4.9392, "gen": 51822367, "dem": 9189650, "net": 42632717},
            {"gsp": "B11", "name": "Melksham", "lat": 51.3687, "lng": -2.1413, "gen": 49053211, "dem": 8855309, "net": 40197902},
            {"gsp": "B7", "name": "Hurst", "lat": 51.4459, "lng": -0.4815, "gen": 22803569, "dem": 5476214, "net": 17327355},
            {"gsp": "B6", "name": "Willesden", "lat": 51.5489, "lng": -0.2356, "gen": 20060765, "dem": 3808108, "net": 16252657},
            {"gsp": "B12", "name": "Exeter", "lat": 50.7184, "lng": -3.5339, "gen": 5020422, "dem": 8092504, "net": -3072082},
            {"gsp": "B5", "name": "City Road", "lat": 51.5319, "lng": -0.0966, "gen": 9041908, "dem": 1799866, "net": 7242042},
            {"gsp": "B4", "name": "Brixton", "lat": 51.4615, "lng": -0.1125, "gen": 8885077, "dem": 988688, "net": 7896389},
            {"gsp": "B14", "name": "Indian Queens", "lat": 50.4019, "lng": -4.9378, "gen": 48373, "dem": 6634421, "net": -6586048},
            {"gsp": "B2", "name": "Ealing", "lat": 51.5154, "lng": -0.2994, "gen": 5401550, "dem": 586820, "net": 4814730},
            {"gsp": "B10", "name": "Bramley", "lat": 51.3244, "lng": -0.9947, "gen": 1419043, "dem": 4487526, "net": -3068483},
            {"gsp": "B17", "name": "Swansea North", "lat": 51.6563, "lng": -3.9436, "gen": 0, "dem": 3926204, "net": -3926204},
            {"gsp": "B1", "name": "Barking", "lat": 51.5362, "lng": 0.081, "gen": 2986255, "dem": 264191, "net": 2722064},
            {"gsp": "B15", "name": "Landulph", "lat": 50.4464, "lng": -4.2124, "gen": 1868674, "dem": 766160, "net": 1102514},
            {"gsp": "B13", "name": "Bristol", "lat": 51.4545, "lng": -2.5879, "gen": 0, "dem": 1863672, "net": -1863672},
            {"gsp": "B3", "name": "Wimbledon", "lat": 51.4214, "lng": -0.2072, "gen": 400343, "dem": 375821, "net": 24522}
        ];

        function initMap() {
            console.log('initMap called');
            document.getElementById('loading').style.display = 'none';
            
            try {
                const map = new google.maps.Map(document.getElementById('map'), {
                    center: { lat: 54, lng: -2.5 },
                    zoom: 6,
                    mapTypeId: 'roadmap',
                    styles: [
                        {"elementType": "geometry", "stylers": [{"color": "#212121"}]},
                        {"elementType": "labels.text.fill", "stylers": [{"color": "#757575"}]},
                        {"elementType": "labels.text.stroke", "stylers": [{"color": "#212121"}]},
                        {"featureType": "water", "elementType": "geometry", "stylers": [{"color": "#000000"}]}
                    ]
                });

                console.log('Map created, adding markers...');
                
                gspData.forEach((gsp, index) => {
                    const isExporting = gsp.net > 0;
                    const circleSize = Math.min(Math.max(Math.abs(gsp.net) / 1000000, 5), 20);
                    
                    const marker = new google.maps.Marker({
                        position: { lat: gsp.lat, lng: gsp.lng },
                        map: map,
                        title: `${gsp.gsp} - ${gsp.name}`,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            fillColor: isExporting ? '#00bcd4' : '#ff9800',
                            fillOpacity: 0.8,
                            strokeColor: '#ffffff',
                            strokeWeight: 2,
                            scale: circleSize
                        }
                    });

                    const infoContent = `
                        <div style="color:#000;padding:15px;max-width:300px">
                            <h3 style="margin:0 0 10px 0;color:${isExporting?'#00bcd4':'#ff9800'}">${gsp.gsp}: ${gsp.name}</h3>
                            <div style="background:${isExporting?'#e0f7fa':'#fff3e0'};padding:12px;border-radius:5px;text-align:center">
                                <div style="font-size:20px;font-weight:bold;color:${isExporting?'#00bcd4':'#ff9800'}">
                                    ${isExporting?'üü¶ EXPORTING':'üüß IMPORTING'}
                                </div>
                                <div style="font-size:16px;font-weight:bold;margin-top:8px">
                                    ${isExporting?'+':''}${gsp.net.toLocaleString()} MW
                                </div>
                            </div>
                            <table style="width:100%;margin-top:10px;border-collapse:collapse">
                                <tr style="border-bottom:1px solid #ddd">
                                    <td style="padding:8px">‚ö° Generation</td>
                                    <td style="text-align:right;padding:8px;font-weight:bold">${gsp.gen.toLocaleString()} MW</td>
                                </tr>
                                <tr style="border-bottom:1px solid #ddd">
                                    <td style="padding:8px">üí° Demand</td>
                                    <td style="text-align:right;padding:8px;font-weight:bold">${gsp.dem.toLocaleString()} MW</td>
                                </tr>
                                <tr>
                                    <td style="padding:8px"><strong>üìä Net Flow</strong></td>
                                    <td style="text-align:right;padding:8px;font-weight:bold;color:${isExporting?'#00bcd4':'#ff9800'}">
                                        ${isExporting?'+':''}${gsp.net.toLocaleString()} MW
                                    </td>
                                </tr>
                            </table>
                        </div>
                    `;

                    const infoWindow = new google.maps.InfoWindow({ content: infoContent });
                    marker.addListener('click', () => {
                        infoWindow.open(map, marker);
                    });
                    
                    console.log(`Added marker ${index + 1}: ${gsp.name}`);
                });

                console.log(`‚úÖ Successfully loaded ${gspData.length} GSP areas`);
                
            } catch (error) {
                console.error('Error creating map:', error);
                document.getElementById('loading').innerHTML = '‚ùå Error loading map: ' + error.message;
                document.getElementById('loading').style.color = '#f44336';
            }
        }

        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Global error:', msg, 'at', lineNo + ':' + columnNo);
            document.getElementById('loading').innerHTML = '‚ùå JavaScript Error: ' + msg;
            document.getElementById('loading').style.color = '#f44336';
            return false;
        };
    </script>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDjw_YjobTs0DCbZwl6p1vXbPSxG6YQNCE&callback=initMap" async defer></script>
</body>
</html>
