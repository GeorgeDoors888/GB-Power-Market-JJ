name: Deploy Arbitrage Job (Cloud Run + Scheduler)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION }}
  CLOUD_RUN_SERVICE: ${{ secrets.CLOUD_RUN_SERVICE }}
  SERVICE_ACCOUNT_EMAIL: ${{ secrets.SERVICE_ACCOUNT_EMAIL }}

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth to Google Cloud (Service Account Key)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Enable required services (idempotent)
        run: |
          gcloud services enable run.googleapis.com \
            cloudscheduler.googleapis.com \
            artifactregistry.googleapis.com \
            bigquery.googleapis.com \
            --project "${GCP_PROJECT_ID}"

      - name: Build & Deploy to Cloud Run (from source)
        run: |
          gcloud run deploy "${CLOUD_RUN_SERVICE}" \
            --source . \
            --project "${GCP_PROJECT_ID}" \
            --region "${GCP_REGION}" \
            --service-account "${SERVICE_ACCOUNT_EMAIL}" \
            --no-allow-unauthenticated \
            --memory=2Gi \
            --timeout=900

      - name: Get Cloud Run URL
        id: runurl
        run: |
          URL=$(gcloud run services describe "${CLOUD_RUN_SERVICE}" \
            --project "${GCP_PROJECT_ID}" \
            --region "${GCP_REGION}" \
            --format="value(status.url)")
          echo "url=${URL}" >> $GITHUB_OUTPUT

      - name: Inject Cloud Run URL into Scheduler JSON
        run: |
          sed -i "s#https://REPLACE_WITH_CLOUD_RUN_URL#${{ steps.runurl.outputs.url }}#g" cloudscheduler_job.json

      - name: Grant Cloud Run Invoker to Scheduler SA (idempotent)
        run: |
          gcloud run services add-iam-policy-binding "${CLOUD_RUN_SERVICE}" \
            --project "${GCP_PROJECT_ID}" \
            --region "${GCP_REGION}" \
            --member="serviceAccount:${SERVICE_ACCOUNT_EMAIL}" \
            --role="roles/run.invoker"

      - name: Create or Update Cloud Scheduler job
        run: |
          JOB_NAME=$(jq -r '.name | split("/") | last' cloudscheduler_job.json)
          if gcloud scheduler jobs describe "${JOB_NAME}" --location="${GCP_REGION}" --project="${GCP_PROJECT_ID}" >/dev/null 2>&1; then
            gcloud scheduler jobs delete "${JOB_NAME}" --location="${GCP_REGION}" --project="${GCP_PROJECT_ID}" --quiet || true
          fi
          gcloud scheduler jobs create http "${JOB_NAME}" \
            --schedule="$(jq -r '.schedule' cloudscheduler_job.json)" \
            --time-zone="$(jq -r '.timeZone' cloudscheduler_job.json)" \
            --uri="$(jq -r '.httpTarget.uri' cloudscheduler_job.json)" \
            --http-method="$(jq -r '.httpTarget.httpMethod' cloudscheduler_job.json)" \
            --oidc-service-account-email="$(jq -r '.httpTarget.oidcToken.serviceAccountEmail' cloudscheduler_job.json)" \
            --oidc-token-audience="$(jq -r '.httpTarget.oidcToken.audience' cloudscheduler_job.json)" \
            --project "${GCP_PROJECT_ID}" \
            --location "${GCP_REGION}"
