BigQuery Data Cleanup Report
==========================
Date: September 6, 2025

Table: bmrs_fuelinst
Dataset: uk_energy_insights
Project: jibber-jabber-knowledge

1. Current Data Coverage
-----------------------
Total date range: August 28-30, 2025 (3 days)
* Aug 28: Full day (48 settlement periods)
* Aug 29: Partial day (25 settlement periods)
* Aug 30: Partial day (4 settlement periods)

2. Data Volume Analysis
----------------------
Current Record Counts:
* Aug 28: 345,600 total records (960 unique data points)
* Aug 29: 671,840 total records (500 unique data points)
* Aug 30: 1,391,200 total records (80 unique data points)
Total: 2,408,640 records

Unique Data Points Expected:
* Aug 28: 960 (48 periods × 20 fuel types)
* Aug 29: 500 (25 periods × 20 fuel types)
* Aug 30: 80 (4 periods × 20 fuel types)
Total unique points: 1,540

3. Duplication Analysis
----------------------
Duplicate Statistics:
* Aug 28: 344,640 duplicate records (99.7% duplicates)
* Aug 29: 671,340 duplicate records (99.9% duplicates)
* Aug 30: 1,391,120 duplicate records (99.9% duplicates)

Example of Duplication (Aug 30, Period 1, BIOMASS):
- Multiple versions (18,864 copies) of the same data point
- Different generation values across versions
- All versions ingested within milliseconds of each other

4. Issues Identified
-------------------
1. Massive Data Duplication:
   - Each data point has thousands of copies
   - Duplicates consume unnecessary storage
   - May impact query performance and costs

2. Inconsistent Values:
   - Different generation values for same time point
   - No clear indication of which version is authoritative
   - May lead to incorrect analysis results

3. Data Completeness:
   - Partial data for Aug 29 and 30
   - Missing periods need investigation
   - May indicate ingestion issues

5. Recommended Actions
---------------------
1. Immediate Actions:
   - Enable billing for the project
   - Grant necessary permissions for table modifications
   - Create a backup of current data before cleanup

2. Data Cleanup:
   - Create new table with only latest versions
   - Use the following deduplication query:
     ```sql
     WITH LatestVersions AS (
         SELECT
             *,
             ROW_NUMBER() OVER (
                 PARTITION BY settlementDate, settlementPeriod, fuelType
                 ORDER BY _ingested_utc DESC
             ) as rn
         FROM `jibber-jabber-knowledge.uk_energy_insights.bmrs_fuelinst`
     )
     SELECT * EXCEPT(rn)
     FROM LatestVersions
     WHERE rn = 1
     ```

3. Process Improvements:
   - Investigate cause of duplicate ingestion
   - Implement deduplication at ingestion time
   - Add uniqueness constraints if possible
   - Set up monitoring for duplicate detection

6. Storage Impact
----------------
Current storage used: Approximately 2.4M rows
After deduplication: 1,540 rows
Storage reduction: 99.9%

7. Query Impact
--------------
Until cleanup is performed, all queries should use the deduplication logic shown above to ensure accurate results.

8. Next Steps
------------
1. Review this report with the data team
2. Enable billing for the project
3. Grant necessary permissions
4. Schedule maintenance window for cleanup
5. Implement process improvements to prevent future duplicates

Note: This cleanup requires administrative access to BigQuery and project billing enabled. Please coordinate with your BigQuery administrator to implement these changes.
