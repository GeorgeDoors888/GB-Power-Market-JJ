<!DOCTYPE html>
<html>
<head>
    <title>UK Power Market - Live DNO Energy Map</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }
        
        #map {
            height: 100vh;
            width: 100%;
        }
        
        /* Control Panel */
        #control-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: 350px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
        }
        
        .panel-header h1 {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .panel-header .subtitle {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .panel-content {
            padding: 20px;
        }
        
        .section {
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            background: #f5f5f5;
            color: #333;
        }
        
        button:hover {
            background: #e0e0e0;
            transform: translateY(-1px);
        }
        
        button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        button.full-width {
            grid-column: 1 / -1;
        }
        
        .info-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 12px;
            line-height: 1.6;
        }
        
        .info-card strong {
            display: block;
            margin-bottom: 8px;
            color: #667eea;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .stat-row:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            color: #666;
        }
        
        .stat-value {
            font-weight: 600;
            color: #333;
        }
        
        /* Legend */
        #legend {
            position: absolute;
            bottom: 30px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: 250px;
        }
        
        .legend-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .legend-color {
            width: 30px;
            height: 20px;
            margin-right: 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .legend-label {
            font-size: 13px;
            color: #333;
        }
        
        /* Loading Indicator */
        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Info Window Styling */
        .gm-style-iw {
            max-width: 300px !important;
        }
        
        /* DNO Key Panel */
        #dno-key {
            position: absolute;
            bottom: 30px;
            left: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: 380px;
            max-height: 70vh;
            overflow-y: auto;
            display: none; /* Hidden by default */
        }
        
        #dno-key.visible {
            display: block;
        }
        
        .key-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .key-title {
            font-size: 16px;
            font-weight: 600;
        }
        
        .toggle-icon {
            font-size: 20px;
            transition: transform 0.3s;
        }
        
        .key-content {
            padding: 15px 20px;
        }
        
        .dno-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            background: #f8f9fa;
            transition: all 0.2s;
        }
        
        .dno-item:hover {
            background: #e9ecef;
            transform: translateX(3px);
        }
        
        .dno-color-box {
            width: 40px;
            height: 30px;
            border-radius: 6px;
            margin-right: 12px;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        
        .dno-info {
            flex-grow: 1;
            min-width: 0;
        }
        
        .dno-name {
            font-weight: 600;
            font-size: 13px;
            color: #333;
            margin-bottom: 2px;
        }
        
        .dno-details {
            font-size: 11px;
            color: #666;
        }
        
        .mpan-badge {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-right: 6px;
        }
        
        .gsp-badge {
            background: #34a853;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Control Panel -->
    <div id="control-panel">
        <div class="panel-header">
            <h1>‚ö° UK Power Market Map</h1>
            <div class="subtitle">Real-time energy data visualization</div>
        </div>
        
        <div class="panel-content">
            <!-- Geographic Layers -->
            <div class="section">
                <div class="section-title">üìç Geographic Layers</div>
                <div class="button-group">
                    <button onclick="loadDNORegions()" id="btn-dno">DNO Regions</button>
                    <button onclick="loadGSPZones()" id="btn-gsp">GSP Zones</button>
                    <button onclick="loadTransmissionZones()" id="btn-transmission">Transmission</button>
                    <button onclick="loadSubstations()" id="btn-substations">Substations</button>
                </div>
            </div>
            
            <!-- Energy Data -->
                        <!-- Energy Data -->
            <div class="section">
                <div class="section-title">‚ö° Energy Data</div>
                <div class="button-group">
                    <button onclick="showGenerationSites()" id="btn-generation">SVA (Embedded)</button>
                    <button onclick="showCVAPlants()" id="btn-cva">CVA (Transmission)</button>
                    <button onclick="showDemandHeatmap()" id="btn-demand">Demand</button>
                    <button onclick="showPriceHeatmap()" id="btn-prices">Prices</button>
                    <button onclick="showWindFarms()" id="btn-wind">Wind Farms</button>
                </div>
            </div>
            
            <!-- Analysis Tools -->
            <div class="section">
                <div class="section-title">üìä Analysis</div>
                <div class="button-group">
                    <button onclick="showFlowArrows()" id="btn-flows">Power Flows</button>
                    <button onclick="showCongestion()" id="btn-congestion">Congestion</button>
                    <button onclick="toggleDNOKey()" id="btn-toggle-key">Toggle DNO Key</button>
                    <button onclick="clearAllLayers()">Clear All Layers</button>
                </div>
            </div>
            
            <!-- Live Stats -->
            <div class="section">
                <div class="section-title">üìà Live Statistics</div>
                <div class="info-card" id="live-stats">
                    <div class="stat-row">
                        <span class="stat-label">Total Generation:</span>
                        <span class="stat-value" id="total-gen">Loading...</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Renewables:</span>
                        <span class="stat-value" id="renewables">Loading...</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">System Price:</span>
                        <span class="stat-value" id="system-price">Loading...</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Frequency:</span>
                        <span class="stat-value" id="frequency">50.00 Hz</span>
                    </div>
                </div>
            </div>
            
            <!-- Info Box -->
            <div class="section">
                <div class="info-card" id="info-box">
                    <strong>‚ÑπÔ∏è Information</strong>
                    Click on map features to see details
                </div>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div id="legend">
        <div class="legend-title">Legend</div>
        <div class="legend-item">
            <div class="legend-color" style="background: rgba(102, 126, 234, 0.4);"></div>
            <span class="legend-label">DNO Region</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: rgba(52, 168, 83, 0.4);"></div>
            <span class="legend-label">GSP Zone</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #fbbc05;"></div>
            <span class="legend-label">Power Station</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #34a853;"></div>
            <span class="legend-label">Wind Farm</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(to right, #4caf50, #ff9800, #f44336);"></div>
            <span class="legend-label">Price Heatmap</span>
        </div>
    </div>
    
    <!-- DNO Key Panel -->
    <div id="dno-key">
        <div class="key-header" onclick="toggleDNOKey()">
            <div class="key-title">üó∫Ô∏è DNO License Areas</div>
            <span class="toggle-icon" id="key-toggle">‚àí</span>
        </div>
        <div class="key-content" id="key-content">
            <div class="dno-item">
                <div class="dno-color-box" style="background: #667eea;"></div>
                <div class="dno-info">
                    <div class="dno-name">UKPN - London</div>
                    <div class="dno-details">
                        <span class="mpan-badge">MPAN 12</span>
                        <span class="gsp-badge">GSP C</span>
                    </div>
                </div>
            </div>
            
            <div class="dno-item">
                <div class="dno-color-box" style="background: #667eea;"></div>
                <div class="dno-info">
                    <div class="dno-name">UKPN - East England</div>
                    <div class="dno-details">
                        <span class="mpan-badge">MPAN 10</span>
                        <span class="gsp-badge">GSP A</span>
                    </div>
                </div>
            </div>
            
            <div class="dno-item">
                <div class="dno-color-box" style="background: #667eea;"></div>
                <div class="dno-info">
                    <div class="dno-name">UKPN - South East England</div>
                    <div class="dno-details">
                        <span class="mpan-badge">MPAN 19</span>
                        <span class="gsp-badge">GSP J</span>
                    </div>
                </div>
            </div>
            
            <div class="dno-item">
                <div class="dno-color-box" style="background: #fbbc05;"></div>
                <div class="dno-info">
                    <div class="dno-name">NGED - East Midlands</div>
                    <div class="dno-details">
                        <span class="mpan-badge">MPAN 11</span>
                        <span class="gsp-badge">GSP B</span>
                    </div>
                </div>
            </div>
            
            <div class="dno-item">
                <div class="dno-color-box" style="background: #fbbc05;"></div>
                <div class="dno-info">
                    <div class="dno-name">NGED - West Midlands</div>
                    <div class="dno-details">
                        <span class="mpan-badge">MPAN 14</span>
                        <span class="gsp-badge">GSP E</span>
                    </div>
                </div>
            </div>
            
            <div class="dno-item">
                <div class="dno-color-box" style="background: #fbbc05;"></div>
                <div class="dno-info">
                    <div class="dno-name">NGED - South Wales</div>
                    <div class="dno-details">
                        <span class="mpan-badge">MPAN 21</span>
                        <span class="gsp-badge">GSP K</span>
                    </div>
                </div>
            </div>
            
            <div class="dno-item">
                <div class="dno-color-box" style="background: #fbbc05;"></div>
                <div class="dno-info">
                    <div class="dno-name">NGED - South West England</div>
                    <div class="dno-details">
                        <span class="mpan-badge">MPAN 22</span>
                        <span class="gsp-badge">GSP L</span>
                    </div>
                </div>
            </div>
            
            <div class="dno-item">
                <div class="dno-color-box" style="background: #34a853;"></div>
                <div class="dno-info">
                    <div class="dno-name">SSEN - Southern England</div>
                    <div class="dno-details">
                        <span class="mpan-badge">MPAN 20</span>
                        <span class="gsp-badge">GSP H</span>
                    </div>
                </div>
            </div>
            
            <div class="dno-item">
                <div class="dno-color-box" style="background: #34a853;"></div>
                <div class="dno-info">
                    <div class="dno-name">SSEN - North Scotland</div>
                    <div class="dno-details">
                        <span class="mpan-badge">MPAN 17</span>
                        <span class="gsp-badge">GSP P</span>
                    </div>
                </div>
            </div>
            
            <div class="dno-item">
                <div class="dno-color-box" style="background: #4285f4;"></div>
                <div class="dno-info">
                    <div class="dno-name">NPG - North East England</div>
                    <div class="dno-details">
                        <span class="mpan-badge">MPAN 15</span>
                        <span class="gsp-badge">GSP F</span>
                    </div>
                </div>
            </div>
            
            <div class="dno-item">
                <div class="dno-color-box" style="background: #4285f4;"></div>
                <div class="dno-info">
                    <div class="dno-name">NPG - Yorkshire</div>
                    <div class="dno-details">
                        <span class="mpan-badge">MPAN 23</span>
                        <span class="gsp-badge">GSP M</span>
                    </div>
                </div>
            </div>
            
            <div class="dno-item">
                <div class="dno-color-box" style="background: #ea4335;"></div>
                <div class="dno-info">
                    <div class="dno-name">ENWL - North West England</div>
                    <div class="dno-details">
                        <span class="mpan-badge">MPAN 16</span>
                        <span class="gsp-badge">GSP G</span>
                    </div>
                </div>
            </div>
            
            <div class="dno-item">
                <div class="dno-color-box" style="background: #764ba2;"></div>
                <div class="dno-info">
                    <div class="dno-name">SPEN - Central Scotland</div>
                    <div class="dno-details">
                        <span class="mpan-badge">MPAN 18</span>
                        <span class="gsp-badge">GSP N</span>
                    </div>
                </div>
            </div>
            
            <div class="dno-item">
                <div class="dno-color-box" style="background: #764ba2;"></div>
                <div class="dno-info">
                    <div class="dno-name">SPEN - North Wales & Merseyside</div>
                    <div class="dno-details">
                        <span class="mpan-badge">MPAN 13</span>
                        <span class="gsp-badge">GSP D</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <script>
        let map;
        let dataLayers = [];
        let currentLayers = {};
        let infoWindow;

        // Toggle DNO Key visibility
        function toggleDNOKey() {
            const content = document.getElementById('key-content');
            const toggle = document.getElementById('key-toggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚àí';
            } else {
                content.style.display = 'none';
                toggle.textContent = '+';
            }
        }

        // Initialize Map
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 6,
                center: { lat: 54.5, lng: -3.5 },
                mapTypeId: 'roadmap',
                styles: [
                    {
                        featureType: 'poi',
                        elementType: 'labels',
                        stylers: [{ visibility: 'off' }]
                    }
                ]
            });

            infoWindow = new google.maps.InfoWindow();

            // Set up feature click listener
            map.data.addListener('click', function(event) {
                showFeatureInfo(event.feature, event.latLng);
            });

            // Load initial data
            loadLiveStats();
            setInterval(loadLiveStats, 60000); // Update every minute
        }

        // Load DNO Regions
        function loadDNORegions() {
            console.log('üó∫Ô∏è Loading DNO regions...');
            updateInfo('Loading DNO regions from BigQuery...');
            toggleButton('btn-dno');
            
            // Fetch real DNO boundaries from static GeoJSON file
            fetch('dno_regions.geojson')
                .then(response => {
                    console.log('üì• Fetch response:', response.status);
                    if (!response.ok) {
                        throw new Error('GeoJSON file not found');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('‚úÖ GeoJSON loaded:', data.features.length, 'features');
                    console.log('First feature:', data.features[0]);
                    
                    // Clear any existing data layers
                    map.data.forEach(feature => {
                        map.data.remove(feature);
                    });
                    
                    // Add GeoJSON to map
                    const addedFeatures = map.data.addGeoJson(data);
                    console.log('‚úÖ Added to map:', addedFeatures.length, 'features');
                    
                    // Style the polygons
                    map.data.setStyle(function(feature) {
                        const dnoCode = feature.getProperty('dno_code');
                        return {
                            fillColor: getDNOColorByCode(dnoCode),
                            fillOpacity: 0.35,
                            strokeColor: getDNOColorByCode(dnoCode),
                            strokeWeight: 2.5
                        };
                    });
                    
                    // Add mouseover handler for hover tooltips
                    map.data.addListener('mouseover', function(event) {
                        const dnoName = event.feature.getProperty('dno_name');
                        const dnoCode = event.feature.getProperty('dno_code');
                        const mpanId = event.feature.getProperty('mpan_id');
                        const gspGroup = event.feature.getProperty('gsp_group');
                        const area = event.feature.getProperty('area');
                        
                        // Show tooltip
                        infoWindow.setContent(`
                            <div style="padding: 8px; min-width: 200px;">
                                <div style="font-size: 14px; font-weight: 600; color: #333; margin-bottom: 4px;">
                                    ${dnoCode} - ${area}
                                </div>
                                <div style="font-size: 12px; color: #666;">
                                    <span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 3px; margin-right: 6px;">MPAN ${mpanId}</span>
                                    <span style="background: #34a853; color: white; padding: 2px 6px; border-radius: 3px;">GSP ${gspGroup.replace('_', '')}</span>
                                </div>
                            </div>
                        `);
                        infoWindow.setPosition(event.latLng);
                        infoWindow.open(map);
                        
                        // Highlight the region
                        map.data.overrideStyle(event.feature, {
                            fillOpacity: 0.6,
                            strokeWeight: 4
                        });
                    });
                    
                    // Add mouseout handler to reset style
                    map.data.addListener('mouseout', function(event) {
                        // Reset style
                        map.data.revertStyle(event.feature);
                        // Close tooltip (optional - comment out if you want it to stay)
                        infoWindow.close();
                    });
                    
                    // Add click handler for detailed info windows
                    map.data.addListener('click', function(event) {
                        const props = {
                            dno_name: event.feature.getProperty('dno_name'),
                            dno_code: event.feature.getProperty('dno_code'),
                            gsp_group: event.feature.getProperty('gsp_group'),
                            gsp_name: event.feature.getProperty('gsp_name'),
                            area: event.feature.getProperty('area'),
                            mpan_id: event.feature.getProperty('mpan_id'),
                            coverage: event.feature.getProperty('coverage'),
                            website: event.feature.getProperty('website'),
                            area_sqkm: event.feature.getProperty('area_sqkm')
                        };
                        
                        infoWindow.setContent(`
                            <div style="padding: 12px; min-width: 300px;">
                                <h3 style="margin: 0 0 12px 0; color: #333;">GSP ${props.gsp_group.replace('_', '')} - ${props.area}</h3>
                                <div style="margin: 8px 0;">
                                    <strong>DNO:</strong> ${props.dno_name}
                                </div>
                                <div style="margin: 8px 0;">
                                    <strong>Code:</strong> ${props.dno_code}
                                </div>
                                <div style="margin: 8px 0;">
                                    <strong>MPAN Distributor ID:</strong> ${props.mpan_id}
                                </div>
                                <div style="margin: 8px 0;">
                                    <strong>GSP Group:</strong> ${props.gsp_name} (${props.gsp_group.replace('_', '')})
                                </div>
                                <div style="margin: 8px 0;">
                                    <strong>Coverage:</strong> ${props.coverage}
                                </div>
                                <div style="margin: 8px 0;">
                                    <strong>Area:</strong> ${props.area_sqkm.toLocaleString()} km¬≤
                                </div>
                                ${props.website ? `<div style="margin: 8px 0;">
                                    <strong>Website:</strong> <a href="${props.website}" target="_blank">Visit</a>
                                </div>` : ''}
                            </div>
                        `);
                        infoWindow.setPosition(event.latLng);
                        infoWindow.open(map);
                    });
                    
                    currentLayers.dno = data;
                    updateInfo(`‚úÖ Loaded ${data.features.length} DNO license areas from BigQuery`);
                    console.log('‚úÖ Updated info display');
                    
                    // Fit map to show all DNO regions using the added features
                    const bounds = new google.maps.LatLngBounds();
                    addedFeatures.forEach(feature => {
                        feature.getGeometry().forEachLatLng(function(latLng) {
                            bounds.extend(latLng);
                        });
                    });
                    map.fitBounds(bounds);
                    console.log('‚úÖ Map bounds fitted to data');
                })
                .catch(err => {
                    console.error('‚ùå Error loading DNO data:', err);
                    console.error('‚ùå Error message:', err.message);
                    console.error('‚ùå Error stack:', err.stack);
                    console.log('‚ö†Ô∏è Falling back to sample rectangles');
                    updateInfo('‚ö†Ô∏è Could not load GeoJSON file. Using sample data.');
                    updateInfo('Run: python generate_dno_geojson.py');
                    loadSampleDNOData();
                });
        }
        
        // Helper function to get color by DNO code
        function getDNOColorByCode(dnoCode) {
            const colors = {
                'UKPN': '#667eea',  // UK Power Networks (3 areas: London, East, South East)
                'SSEN': '#34a853',  // Scottish & Southern Electricity Networks (2 areas: South, North Scotland)
                'NGED': '#fbbc05',  // National Grid ED (4 areas: East/West Midlands, South Wales/West)
                'ENWL': '#ea4335',  // Electricity North West
                'NPG': '#4285f4',   // Northern Powergrid (2 areas: North East, Yorkshire)
                'SPEN': '#764ba2'   // SP Energy Networks (2 areas: Scotland, Merseyside/Wales)
            };
            return colors[dnoCode] || '#888888';
        }

        // Load sample DNO data (fallback)
        function loadSampleDNOData() {
            const dnoRegions = [
                // England - South
                { name: 'UKPN - London', bounds: [[51.28, -0.51], [51.69, 0.33]], color: '#667eea' },
                { name: 'UKPN - South East', bounds: [[50.75, -0.75], [51.50, 1.45]], color: '#667eea' },
                { name: 'UKPN - Eastern', bounds: [[51.50, -0.50], [52.80, 1.75]], color: '#667eea' },
                { name: 'SSEN - South', bounds: [[50.20, -5.72], [51.60, -2.00]], color: '#34a853' },
                { name: 'Western Power - South West', bounds: [[50.00, -5.75], [51.70, -2.00]], color: '#fbbc05' },
                { name: 'Western Power - South Wales', bounds: [[51.38, -5.30], [52.40, -2.65]], color: '#fbbc05' },
                { name: 'Western Power - West Midlands', bounds: [[51.75, -3.00], [53.00, -1.40]], color: '#fbbc05' },
                { name: 'Western Power - East Midlands', bounds: [[52.30, -1.80], [53.50, -0.20]], color: '#fbbc05' },
                
                // England - North
                { name: 'Electricity North West', bounds: [[53.00, -3.20], [54.50, -2.10]], color: '#ea4335' },
                { name: 'Northern Powergrid - North East', bounds: [[54.40, -2.50], [55.80, -1.00]], color: '#4285f4' },
                { name: 'Northern Powergrid - Yorkshire', bounds: [[53.30, -2.30], [54.50, -0.40]], color: '#4285f4' },
                
                // Scotland
                { name: 'SSEN - North Scotland', bounds: [[56.50, -7.70], [58.70, -1.50]], color: '#34a853' },
                { name: 'SP Energy Networks - Central & South Scotland', bounds: [[54.90, -5.00], [56.50, -2.00]], color: '#764ba2' },
                { name: 'SP Energy Networks - Merseyside & North Wales', bounds: [[52.80, -4.80], [53.70, -2.70]], color: '#764ba2' }
            ];

            dnoRegions.forEach(region => {
                const rectangle = new google.maps.Rectangle({
                    bounds: {
                        north: region.bounds[1][0],
                        south: region.bounds[0][0],
                        east: region.bounds[1][1],
                        west: region.bounds[0][1]
                    },
                    map: map,
                    fillColor: region.color,
                    fillOpacity: 0.25,
                    strokeColor: region.color,
                    strokeWeight: 2.5
                });

                rectangle.addListener('click', () => {
                    const area = ((region.bounds[1][0] - region.bounds[0][0]) * (region.bounds[1][1] - region.bounds[0][1]) * 111 * 111).toFixed(0);
                    infoWindow.setContent(`
                        <div style="padding: 10px;">
                            <h3 style="margin: 0 0 10px 0;">${region.name}</h3>
                            <p style="margin: 5px 0;"><strong>Type:</strong> Distribution Network Operator</p>
                            <p style="margin: 5px 0;"><strong>Approx Area:</strong> ${area.toLocaleString()} km¬≤</p>
                        </div>
                    `);
                    infoWindow.setPosition({
                        lat: (region.bounds[0][0] + region.bounds[1][0]) / 2,
                        lng: (region.bounds[0][1] + region.bounds[1][1]) / 2
                    });
                    infoWindow.open(map);
                });

                dataLayers.push(rectangle);
            });
            
            updateInfo(`Loaded ${dnoRegions.length} DNO regions (14 UK operators)`);
        }

        // Load GSP Zones
        function loadGSPZones() {
            console.log('üó∫Ô∏è Loading GSP zones...');
            updateInfo('Loading GSP zones from BigQuery...');
            toggleButton('btn-gsp');
            
            // Fetch GSP zone boundaries from static GeoJSON file
            fetch('gsp_zones.geojson')
                .then(response => {
                    console.log('üì• Fetch GSP response:', response.status);
                    if (!response.ok) {
                        throw new Error('GSP GeoJSON file not found');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('‚úÖ GSP GeoJSON loaded:', data.features.length, 'features');
                    
                    // Create a separate Data layer for GSP zones to avoid conflicts with DNO layer
                    if (!window.gspDataLayer) {
                        window.gspDataLayer = new google.maps.Data({ map: map });
                    }
                    
                    // Clear existing GSP features
                    window.gspDataLayer.forEach(feature => {
                        window.gspDataLayer.remove(feature);
                    });
                    
                    // Add GeoJSON to GSP layer
                    const addedFeatures = window.gspDataLayer.addGeoJson(data);
                    console.log('‚úÖ Added GSP zones to map:', addedFeatures.length, 'features');
                    
                    // Style the GSP polygons (lighter, distinct from DNO)
                    window.gspDataLayer.setStyle(function(feature) {
                        return {
                            fillColor: '#9c27b0',      // Purple for GSP zones
                            fillOpacity: 0.08,         // Very transparent for background layer
                            strokeColor: '#7b1fa2',    // Darker purple stroke
                            strokeWeight: 1.0          // Thinner than DNO
                        };
                    });
                    
                    // Add mouseover handler for GSP hover tooltips
                    window.gspDataLayer.addListener('mouseover', function(event) {
                        const gspId = event.feature.getProperty('gsp_id');
                        const gspName = event.feature.getProperty('gsp_name');
                        const gspGroup = event.feature.getProperty('gsp_group');
                        const areaSqKm = event.feature.getProperty('area_sqkm');
                        
                        // Show tooltip
                        infoWindow.setContent(`
                            <div style="padding: 8px; min-width: 180px;">
                                <div style="font-size: 14px; font-weight: 600; color: #7b1fa2; margin-bottom: 4px;">
                                    ${gspName}
                                </div>
                                <div style="font-size: 11px; color: #666; margin-bottom: 4px;">
                                    <span style="background: #9c27b0; color: white; padding: 2px 6px; border-radius: 3px;">GSP Zone</span>
                                </div>
                                <div style="font-size: 11px; color: #666;">
                                    ${gspGroup ? `Group: ${gspGroup}<br>` : ''}
                                    Area: ${areaSqKm.toLocaleString()} km¬≤
                                </div>
                            </div>
                        `);
                        infoWindow.setPosition(event.latLng);
                        infoWindow.open(map);
                        
                        // Highlight the zone
                        window.gspDataLayer.overrideStyle(event.feature, {
                            fillOpacity: 0.4,
                            strokeWeight: 3
                        });
                    });
                    
                    // Add mouseout handler to reset style
                    window.gspDataLayer.addListener('mouseout', function(event) {
                        window.gspDataLayer.revertStyle(event.feature);
                        infoWindow.close();
                    });
                    
                    // Add click handler for detailed GSP info
                    window.gspDataLayer.addListener('click', function(event) {
                        const props = {
                            gsp_id: event.feature.getProperty('gsp_id'),
                            gsp_name: event.feature.getProperty('gsp_name'),
                            gsp_group: event.feature.getProperty('gsp_group'),
                            region_name: event.feature.getProperty('region_name'),
                            area_sqkm: event.feature.getProperty('area_sqkm')
                        };
                        
                        infoWindow.setContent(`
                            <div style="padding: 12px; min-width: 280px;">
                                <h3 style="margin: 0 0 12px 0; color: #7b1fa2;">${props.gsp_name}</h3>
                                <div style="margin: 8px 0;">
                                    <strong>GSP ID:</strong> ${props.gsp_id}
                                </div>
                                ${props.gsp_group ? `<div style="margin: 8px 0;">
                                    <strong>GSP Group:</strong> ${props.gsp_group}
                                </div>` : ''}
                                ${props.region_name ? `<div style="margin: 8px 0;">
                                    <strong>Region:</strong> ${props.region_name}
                                </div>` : ''}
                                <div style="margin: 8px 0;">
                                    <strong>Area:</strong> ${props.area_sqkm.toLocaleString()} km¬≤
                                </div>
                                <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #eee; font-size: 11px; color: #666;">
                                    Grid Supply Point Zone
                                </div>
                            </div>
                        `);
                        infoWindow.setPosition(event.latLng);
                        infoWindow.open(map);
                    });
                    
                    currentLayers.gsp = data;
                    updateInfo(`‚úÖ Loaded ${data.features.length} GSP zones from BigQuery`);
                    console.log('‚úÖ GSP zones displayed');
                })
                .catch(error => {
                    console.error('‚ùå Error loading GSP zones:', error);
                    updateInfo('‚ö†Ô∏è Error loading GSP zones: ' + error.message);
                });
        }

        // Show Generation Sites
        function showGenerationSites() {
            console.log('‚ö° Loading real generator data...');
            updateInfo('Loading 7,072 generators from NESO data...');
            toggleButton('btn-generation');
            
            // Load real generator data from JSON
            fetch('generators.json')
                .then(response => {
                    console.log('üì• Fetch generators response:', response.status);
                    if (!response.ok) {
                        throw new Error('Generators JSON file not found');
                    }
                    return response.json();
                })
                .then(generators => {
                    console.log(`‚úÖ Loaded ${generators.length} generators`);
                    
                    // Create marker clusterer for better performance with 7000+ markers
                    if (!window.generatorMarkers) {
                        window.generatorMarkers = [];
                    }
                    
                    // Clear existing markers
                    window.generatorMarkers.forEach(marker => marker.setMap(null));
                    window.generatorMarkers = [];
                    
                    // Filter for only generators above certain size for initial display (performance)
                    // User can toggle to show all
                    const minCapacity = 1.0; // MW - show generators 1MW and above
                    const filteredGenerators = generators.filter(g => g.capacity >= minCapacity);
                    
                    console.log(`üìä Showing ${filteredGenerators.length} generators (‚â•${minCapacity} MW)`);
                    
                    // Add markers for each generator
                    filteredGenerators.forEach(gen => {
                        // Calculate marker size based on capacity (with reasonable limits)
                        const baseSize = Math.min(Math.max(Math.sqrt(gen.capacity) * 0.8, 3), 15);
                        
                        const marker = new google.maps.Marker({
                            position: { lat: gen.lat, lng: gen.lng },
                            map: map,
                            title: `${gen.name} (${gen.capacity} MW)`,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: baseSize,
                                fillColor: getGenerationColor(gen.type),
                                fillOpacity: 0.7,
                                strokeColor: '#ffffff',
                                strokeWeight: 1
                            },
                            optimized: true  // Performance optimization
                        });
                        
                        // Add click listener
                        marker.addListener('click', () => {
                            infoWindow.setContent(`
                                <div style="padding: 12px; min-width: 250px;">
                                    <h3 style="margin: 0 0 12px 0; color: #333;">${gen.name}</h3>
                                    <div style="margin: 8px 0;">
                                        <strong>Type:</strong> 
                                        <span style="color: ${getGenerationColor(gen.type)}; font-weight: 600;">
                                            ${gen.type}
                                        </span>
                                    </div>
                                    <div style="margin: 8px 0;">
                                        <strong>Capacity:</strong> ${gen.capacity.toLocaleString()} MW
                                    </div>
                                    ${gen.source ? `<div style="margin: 8px 0;">
                                        <strong>Energy Source:</strong> ${gen.source}
                                    </div>` : ''}
                                    ${gen.dno ? `<div style="margin: 8px 0;">
                                        <strong>DNO:</strong> ${gen.dno}
                                    </div>` : ''}
                                    ${gen.gsp ? `<div style="margin: 8px 0;">
                                        <strong>GSP:</strong> ${gen.gsp}
                                    </div>` : ''}
                                    ${gen.postcode ? `<div style="margin: 8px 0;">
                                        <strong>Location:</strong> ${gen.postcode}
                                    </div>` : ''}
                                    <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #eee; font-size: 11px; color: #666;">
                                        NESO Registered Generator
                                    </div>
                                </div>
                            `);
                            infoWindow.open(map, marker);
                        });
                        
                        window.generatorMarkers.push(marker);
                    });
                    
                    // Calculate statistics
                    const totalCapacity = generators.reduce((sum, g) => sum + g.capacity, 0);
                    const typeBreakdown = {};
                    generators.forEach(g => {
                        typeBreakdown[g.type] = (typeBreakdown[g.type] || 0) + 1;
                    });
                    
                    const topTypes = Object.entries(typeBreakdown)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5)
                        .map(([type, count]) => `${type} (${count})`)
                        .join(', ');
                    
                    updateInfo(`‚úÖ Loaded ${filteredGenerators.length} generators (${totalCapacity.toFixed(0)} MW total)<br>
                               <small>Types: ${topTypes}</small>`);
                    
                    console.log('‚úÖ Generator markers displayed');
                })
                .catch(error => {
                    console.error('‚ùå Error loading generators:', error);
                    updateInfo('‚ö†Ô∏è Error loading generators: ' + error.message);
                });
        }

        // ==================== CVA PLANTS ====================
        // Load and display CVA (Central Volume Allocation) plants
        // These are transmission-connected power stations (nuclear, major CCGT, offshore wind)
        function showCVAPlants() {
            updateInfo('Loading CVA plants from electricityproduction.uk data...');
            toggleButton('btn-cva');
            
            // Check if file exists
            fetch('cva_plants_map.json')
                .then(response => {
                    console.log('üì• Fetch CVA plants response:', response.status);
                    if (!response.ok) {
                        throw new Error('CVA plants JSON file not found. Please run generate_cva_map_json.py after scraping completes.');
                    }
                    return response.json();
                })
                .then(cvaPlants => {
                    console.log(`‚úÖ Loaded ${cvaPlants.length} CVA plants`);
                    
                    // Count by type
                    const typeCounts = {};
                    const typeCapacity = {};
                    
                    // Clear any existing CVA markers
                    if (window.cvaMarkers) {
                        window.cvaMarkers.forEach(m => m.setMap(null));
                    }
                    window.cvaMarkers = [];
                    
                    // Create markers for each CVA plant
                    cvaPlants.forEach(plant => {
                        // Track statistics
                        const type = plant.type_category || 'Other';
                        typeCounts[type] = (typeCounts[type] || 0) + 1;
                        typeCapacity[type] = (typeCapacity[type] || 0) + (plant.capacity || 0);
                        
                        // Get color based on fuel type
                        const color = getCVAColor(plant.type_category);
                        
                        // Calculate marker size based on capacity
                        // CVA plants are typically larger, so use larger base size
                        const capacity = plant.capacity || 0;
                        let scale;
                        if (capacity >= 1000) scale = 12;  // Gigawatt scale
                        else if (capacity >= 500) scale = 10;
                        else if (capacity >= 200) scale = 8;
                        else if (capacity >= 100) scale = 6;
                        else if (capacity >= 50) scale = 5;
                        else scale = 4;
                        
                        // Create triangle marker for CVA (vs circle for SVA)
                        const marker = new google.maps.Marker({
                            position: { lat: plant.lat, lng: plant.lng },
                            map: map,
                            icon: {
                                path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,  // Triangle
                                scale: scale,
                                fillColor: color,
                                fillOpacity: 0.85,
                                strokeColor: '#000000',  // Black border to distinguish from SVA
                                strokeWeight: 2,
                                rotation: 0  // Point up
                            },
                            title: `${plant.name} (CVA - ${plant.capacity ? plant.capacity.toFixed(1) : 'N/A'} MW)`,
                            zIndex: 1000  // Above SVA generators
                        });
                        
                        // Info window with CVA-specific data
                        marker.addListener('click', () => {
                            const content = `
                                <div style="font-family: Arial, sans-serif; min-width: 200px;">
                                    <h3 style="margin: 0 0 10px 0; color: #1a73e8;">${plant.name}</h3>
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tr><td style="padding: 4px 8px 4px 0;"><strong>Type:</strong></td><td style="padding: 4px 0;">CVA (Transmission)</td></tr>
                                        <tr><td style="padding: 4px 8px 4px 0;"><strong>Capacity:</strong></td><td style="padding: 4px 0;">${plant.capacity ? plant.capacity.toFixed(1) + ' MW' : 'Unknown'}</td></tr>
                                        <tr><td style="padding: 4px 8px 4px 0;"><strong>Fuel:</strong></td><td style="padding: 4px 0;">${plant.fuel_type || 'Unknown'}</td></tr>
                                        <tr><td style="padding: 4px 8px 4px 0;"><strong>Category:</strong></td><td style="padding: 4px 0;">${plant.type_category || 'Other'}</td></tr>
                                        ${plant.status ? `<tr><td style="padding: 4px 8px 4px 0;"><strong>Status:</strong></td><td style="padding: 4px 0;">${plant.status}</td></tr>` : ''}
                                        ${plant.operator ? `<tr><td style="padding: 4px 8px 4px 0;"><strong>Operator:</strong></td><td style="padding: 4px 0;">${plant.operator}</td></tr>` : ''}
                                        <tr><td style="padding: 4px 8px 4px 0;"><strong>Location:</strong></td><td style="padding: 4px 0;">${plant.lat.toFixed(4)}, ${plant.lng.toFixed(4)}</td></tr>
                                    </table>
                                    ${plant.url ? `<p style="margin: 10px 0 0 0;"><a href="${plant.url}" target="_blank" style="color: #1a73e8;">View Details ‚Üí</a></p>` : ''}
                                </div>
                            `;
                            infoWindow.setContent(content);
                            infoWindow.open(map, marker);
                        });
                        
                        window.cvaMarkers.push(marker);
                    });
                    
                    // Calculate total capacity
                    const totalCapacity = cvaPlants.reduce((sum, p) => sum + (p.capacity || 0), 0);
                    
                    // Build breakdown text
                    let breakdown = '<strong>Breakdown by Type:</strong><br>';
                    const sortedTypes = Object.keys(typeCounts).sort((a, b) => typeCapacity[b] - typeCapacity[a]);
                    sortedTypes.forEach(type => {
                        const pct = ((typeCapacity[type] / totalCapacity) * 100).toFixed(1);
                        breakdown += `${type}: ${typeCounts[type]} plants, ${typeCapacity[type].toFixed(0)} MW (${pct}%)<br>`;
                    });
                    
                    updateInfo(`‚úÖ Loaded ${cvaPlants.length} CVA plants (${totalCapacity.toFixed(0)} MW total)<br>${breakdown}`);
                    
                    console.log('üìä CVA Plants by type:', typeCounts);
                    console.log('üìä CVA Capacity by type (MW):', typeCapacity);
                })
                .catch(error => {
                    console.error('‚ùå Error loading CVA plants:', error);
                    updateInfo('‚ùå CVA plants not available yet. Please complete web scraping first.<br>' +
                              'Run: python scrape_plants_optimized.py<br>' +
                              'Then: python generate_cva_map_json.py');
                });
        }
        
        // Get color for CVA plant based on type
        function getCVAColor(typeCategory) {
            const colors = {
                'Wind': '#4CAF50',          // Green
                'Solar': '#FFC107',         // Amber
                'Gas': '#FF5722',           // Deep orange
                'Nuclear': '#9C27B0',       // Purple
                'Hydro': '#2196F3',         // Blue
                'Biomass': '#795548',       // Brown
                'Coal': '#424242',          // Dark grey
                'Storage': '#00BCD4',       // Cyan
                'Oil': '#E91E63',           // Pink
                'Other': '#9E9E9E'          // Grey
            };
            return colors[typeCategory] || colors['Other'];
        }

        // Show Price Heatmap
        function showPriceHeatmap() {
            updateInfo('Loading price heatmap...');
            toggleButton('btn-prices');
            
            // Price heatmap implementation
            updateInfo('Price heatmap activated');
        }

        // Load Live Statistics
        function loadLiveStats() {
            // Fetch real-time data from your backend/BigQuery
            // For now, using sample data
            
            document.getElementById('total-gen').textContent = '34.2 GW';
            document.getElementById('renewables').textContent = '45.3%';
            document.getElementById('system-price').textContent = '¬£76.50/MWh';
            document.getElementById('frequency').textContent = '49.98 Hz';
        }

        // Helper Functions
        function getDNOColor(dnoName) {
            const colors = {
                'UKPN': '#667eea',
                'SSEN': '#34a853',
                'Northern': '#fbbc05',
                'ENWL': '#ea4335',
                'SPEN': '#764ba2',
                'WPD': '#4285f4'
            };
            
            for (let key in colors) {
                if (dnoName && dnoName.includes(key)) return colors[key];
            }
            return '#999999';
        }

        function getGenerationColor(type) {
            const colors = {
                'Solar': '#fbbc05',           // Yellow/Gold
                'Wind': '#34a853',            // Green
                'Gas': '#ea4335',             // Red
                'Storage': '#9c27b0',         // Purple
                'Stored Energy': '#9c27b0',  // Purple
                'STORED ENERGY (ALL STORED ENERGY IRRESPECTVE OF THE ORIGINAL ENERGY SOURCE)': '#9c27b0',
                'Stored Energy (all stored energy irrespective of the original energy source)': '#9c27b0',
                'Biomass': '#8ab4f8',         // Light Blue
                'Hydro': '#4285f4',           // Blue
                'Nuclear': '#7b1fa2',         // Dark Purple
                'Coal': '#5f6368',            // Gray
                'Fossil - Oil': '#ea4335',    // Red
                'FOSSIL - OIL': '#ea4335',    // Red
                'Waste': '#ff9800',           // Orange
                'OTHER': '#999999',           // Gray
                'data not available': '#cccccc',  // Light Gray
                'Other': '#999999'            // Gray
            };
            
            // Check for exact match first
            if (colors[type]) return colors[type];
            
            // Check for partial matches (case-insensitive)
            const typeLower = type.toLowerCase();
            if (typeLower.includes('solar')) return '#fbbc05';
            if (typeLower.includes('wind')) return '#34a853';
            if (typeLower.includes('gas')) return '#ea4335';
            if (typeLower.includes('storage') || typeLower.includes('stored')) return '#9c27b0';
            if (typeLower.includes('biomass') || typeLower.includes('biogas')) return '#8ab4f8';
            if (typeLower.includes('hydro')) return '#4285f4';
            if (typeLower.includes('nuclear')) return '#7b1fa2';
            if (typeLower.includes('coal')) return '#5f6368';
            if (typeLower.includes('oil')) return '#ea4335';
            if (typeLower.includes('waste')) return '#ff9800';
            
            // Default gray for unknown
            return '#999999';
        }

        function toggleButton(btnId) {
            const button = document.getElementById(btnId);
            button.classList.toggle('active');
        }

        function updateInfo(text) {
            document.getElementById('info-box').innerHTML = `
                <strong>‚ÑπÔ∏è Information</strong>
                ${text}
            `;
        }

        function showFeatureInfo(feature, latLng) {
            let content = '<div style="padding: 10px;"><strong>Feature Properties:</strong><br>';
            
            feature.forEachProperty((value, name) => {
                content += `${name}: ${value}<br>`;
            });
            
            content += '</div>';
            
            infoWindow.setContent(content);
            infoWindow.setPosition(latLng);
            infoWindow.open(map);
        }

        function clearAllLayers() {
            map.data.forEach(feature => map.data.remove(feature));
            dataLayers.forEach(layer => layer.setMap(null));
            dataLayers = [];
            currentLayers = {};
            
            document.querySelectorAll('button.active').forEach(btn => {
                btn.classList.remove('active');
            });
            
            updateInfo('All layers cleared');
        }

        // Additional stub functions
        function loadTransmissionZones() { updateInfo('Transmission zones coming soon...'); }
        function loadSubstations() { updateInfo('Substations layer coming soon...'); }
        function showDemandHeatmap() { updateInfo('Demand heatmap coming soon...'); }
        function showWindFarms() { updateInfo('Wind farms layer coming soon...'); }
        function showFlowArrows() { updateInfo('Power flow arrows coming soon...'); }
        function showCongestion() { updateInfo('Congestion analysis coming soon...'); }
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDcOg5CC4rbf0SujJ4JurGWknUlawVnct0&callback=initMap" async defer></script>
</body>
</html>
